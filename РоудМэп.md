1) Backlog задач (конкретно, по итерациям)
Итерация 0 — Репозиторий, каркас, стандарты
1.	Инициализировать репозиторий
o	pyproject.toml (poetry/uv), зависимости
o	pre-commit (black/ruff/isort/mypy)
2.	Docker окружение
o	docker-compose.yml: postgres, redis, bot, worker, admin-web
o	.env.example
3.	Базовая конфигурация приложения
o	pydantic-settings для конфигов
o	загрузка ENV
4.	Логирование
o	структурные логи (order_id, stage_id, user_id)
o	уровни: INFO/ERROR
Acceptance: docker compose up поднимает все сервисы, бот и веб-админ стартуют без бизнес-логики.
________________________________________
Итерация 1 — Данные и доменная модель “под 4 этапа”
5.	Схема БД + миграции
o	users
o	orders
o	order_stages
o	payments
o	artifacts
o	provider_configs (ключи/параметры)
o	product_configs (цены/офферы/вкл)
o	content_policies (юмор/стоп-слова/ретраи)
6.	SQLAlchemy модели + репозитории
o	UserRepo, OrderRepo, StageRepo, PaymentRepo, ArtifactRepo, ConfigRepo
7.	Enum-ы статусов
o	OrderStageStatus, PaymentStatus, ProviderKind, ArtifactType
Acceptance: можно создать order/stage в БД и прочитать обратно через репозитории.
________________________________________
Итерация 2 — ЮKassa: платеж за этап (Poem 49₽)
8.	Интеграция ЮKassa Client
o	создание платежа (amount, description, metadata: order_id, stage_id)
o	idempotency key
9.	Webhook endpoint (admin-web)
o	валидация источника (по правилам ЮKassa)
o	идемпотентность: один event → одно изменение
o	обновление payment + stage status
10.	Use-case StartPayment (для Poem)
11.	Use-case HandlePaymentWebhook
o	если succeeded → stage paid + постановка celery-task
Acceptance: оплата переводит stage в paid, после webhook запускается генерация.
________________________________________
Итерация 3 — AI-провайдеры (YandexGPT + тестовые) и генерация стиха
12.	Интерфейсы провайдеров
o	TextProvider (YandexGPT, Dummy/Test)
13.	Промпт и сборка контекста
o	строгая структура: 3–4 четверостишья, рифма
o	юмор: жёстко без брани
14.	Контент-политика
o	словарь стоп-слов (редактируемый из админки)
o	пост-валидация результата + 1–2 ретрая
15.	Celery task generate_poem(stage_id)
o	проверка paid
o	status → processing → done/failed
o	сохранение текста в artifacts (type=text)
Acceptance: после оплаты бот выдаёт стих, результат сохраняется и повторно отдаётся из БД.
________________________________________
Итерация 4 — Bot FSM (сложная машина состояний) + UX
16.	FSM: сбор данных стиха
o	повод, кому/имя, детали, стиль (юмор/сарказм по умолчанию)
o	“назад/изменить”
17.	Создание order + stage (Poem)
18.	Экран подтверждения + кнопка оплаты
19.	Ожидание генерации
o	polling или событие (минимум: polling по stage status)
20.	Выдача результата + апселл-заглушка
Acceptance: пользователь проходит путь start → параметры → оплата → стих → предложение апселла.
________________________________________
Итерация 5 — Админка (веб) v1: ключи, цены, мониторинг, политики
21.	Auth для админки
o	admin user в ENV или таблице (лучше таблица)
22.	UI “Продукты/Этапы”
o	Poem 49, Voice +199, Song +990, Clip base 599 + tariffs (пока пусто)
o	включение/выключение
o	тексты офферов
23.	UI “Провайдеры и ключи”
o	YandexGPT active + key + params
o	TestProvider active + params
24.	UI “Политики контента”
o	режим юмора hard_no_profanity
o	стоп-слова + ретраи
o	требования к стиху (3–4 четверостишья, рифма)
25.	UI “Заказы/Мониторинг”
o	список заказов, стадии, статусы, ошибки
o	кнопки: requeue stage, mark failed, view artifacts
Acceptance: без правок кода можно сменить ключ/провайдера/цену и это влияет на поведение.
________________________________________
Итерации 6–8 (следующие) — Voice/Song/Clip + Object Storage + “Мои творения”
26.	Object Storage модуль
o	upload, signed url, delete, TTL
27.	SpeechKit stage
28.	Suno stage
29.	Pika/Runway stage + tariffs
30.	“Мои творения” в боте
o	список orders, просмотр артефактов
________________________________________
2) Точная структура проекта (для IDE)
project/
├─ app/
│  ├─ bot/
│  │  ├─ __init__.py
│  │  ├─ main.py                # запуск aiogram
│  │  ├─ routers/
│  │  │  ├─ __init__.py
│  │  │  ├─ start.py
│  │  │  ├─ poem_flow.py
│  │  │  ├─ cabinet.py          # "Мои творения"
│  │  │  └─ admin_shortcuts.py  # (опц.) админ-команды в боте
│  │  ├─ fsm/
│  │  │  ├─ __init__.py
│  │  │  └─ states.py
│  │  ├─ keyboards/
│  │  │  ├─ __init__.py
│  │  │  ├─ common.py
│  │  │  └─ payments.py
│  │  ├─ texts/
│  │  │  ├─ __init__.py
│  │  │  ├─ ru.py
│  │  │  └─ templates.py
│  │  └─ utils/
│  │     ├─ __init__.py
│  │     └─ formatting.py
│  │
│  ├─ web/
│  │  ├─ __init__.py
│  │  ├─ main.py                # FastAPI app (admin + webhooks)
│  │  ├─ auth.py
│  │  ├─ deps.py                # зависимости/DI
│  │  ├─ routes/
│  │  │  ├─ __init__.py
│  │  │  ├─ admin.py            # страницы админки
│  │  │  └─ yookassa_webhook.py # webhook endpoint
│  │  ├─ templates/
│  │  │  ├─ layout.html
│  │  │  ├─ login.html
│  │  │  ├─ dashboard.html
│  │  │  ├─ products.html
│  │  │  ├─ providers.html
│  │  │  ├─ policies.html
│  │  │  └─ orders.html
│  │  └─ static/
│  │     └─ admin.css
│  │
│  ├─ application/
│  │  ├─ __init__.py
│  │  ├─ use_cases/
│  │  │  ├─ __init__.py
│  │  │  ├─ create_order.py
│  │  │  ├─ start_payment.py
│  │  │  ├─ handle_yookassa_webhook.py
│  │  │  ├─ enqueue_stage_job.py
│  │  │  ├─ deliver_result.py
│  │  │  └─ get_user_cabinet.py
│  │  ├─ services/
│  │  │  ├─ __init__.py
│  │  │  ├─ prompt_builder.py
│  │  │  ├─ content_policy.py
│  │  │  ├─ upsell_engine.py
│  │  │  └─ pricing.py
│  │  └─ dto/
│  │     ├─ __init__.py
│  │     └─ schemas.py
│  │
│  ├─ domain/
│  │  ├─ __init__.py
│  │  ├─ enums.py
│  │  ├─ errors.py
│  │  └─ entities.py            # dataclasses/pydantic domain models
│  │
│  ├─ infra/
│  │  ├─ __init__.py
│  │  ├─ db/
│  │  │  ├─ __init__.py
│  │  │  ├─ base.py             # Base, session, engine
│  │  │  ├─ models.py           # SQLAlchemy ORM
│  │  │  ├─ repositories.py
│  │  │  └─ migrations/         # alembic
│  │  ├─ ai/
│  │  │  ├─ __init__.py
│  │  │  ├─ base.py             # интерфейсы
│  │  │  ├─ yandex_gpt.py
│  │  │  └─ test_provider.py
│  │  ├─ payments/
│  │  │  ├─ __init__.py
│  │  │  └─ yookassa.py
│  │  ├─ queue/
│  │  │  ├─ __init__.py
│  │  │  ├─ celery_app.py
│  │  │  └─ tasks.py
│  │  └─ storage/
│  │     ├─ __init__.py
│  │     └─ yandex_object_storage.py
│  │
│  ├─ config/
│  │  ├─ __init__.py
│  │  └─ settings.py
│  │
│  └─ main.py                   # единая точка входа (опц.)
│
├─ tests/
│  ├─ test_prompt_builder.py
│  ├─ test_content_policy.py
│  └─ test_order_flow.py
│
├─ docker/
│  ├─ bot.Dockerfile
│  ├─ worker.Dockerfile
│  └─ web.Dockerfile
│
├─ docker-compose.yml
├─ pyproject.toml
└─ README.md
________________________________________
3) Схема БД (точно: таблицы и ключевые поля)
enums (в коде)
•	StageType: POEM, VOICE, SONG, CLIP
•	StageStatus: DRAFT, AWAITING_PAYMENT, PAID, QUEUED, PROCESSING, DONE, FAILED, CANCELED
•	PaymentStatus: PENDING, SUCCEEDED, CANCELED, FAILED
•	ProviderKind: TEXT, TTS, MUSIC, VIDEO
•	ArtifactType: TEXT, AUDIO, TRACK, VIDEO
users
•	id (uuid, pk)
•	telegram_id (bigint, unique)
•	username (text, null)
•	created_at (timestamptz)
orders
•	id (uuid, pk)
•	user_id (fk users.id)
•	created_at (timestamptz)
•	context_json (jsonb) — общий контекст заказа (имя, повод, детали)
•	current_stage (enum StageType, null) — удобно для UI
order_stages
•	id (uuid, pk)
•	order_id (fk orders.id)
•	stage_type (enum StageType)
•	status (enum StageStatus)
•	price_rub (int)
•	pricing_option_id (uuid/null) — для Clip-тарифов
•	input_json (jsonb) — вход этапа (для стиха: промпт-данные)
•	provider_key (text) — какой провайдер был использован (например yandex_gpt)
•	error_message (text, null)
•	created_at, updated_at (timestamptz)
unique constraint: (order_id, stage_type, created_at) или проще: позволяем несколько попыток одного этапа (повтор) — тогда stage отдельный объект каждой попытки.
payments
•	id (uuid, pk)
•	order_id (fk)
•	stage_id (fk order_stages.id)
•	provider (text, default yookassa)
•	yookassa_payment_id (text, unique)
•	status (enum PaymentStatus)
•	amount_rub (int)
•	idempotency_key (text, unique)
•	raw_payload_json (jsonb)
•	created_at, updated_at
artifacts
•	id (uuid, pk)
•	order_id (fk)
•	stage_id (fk)
•	type (enum ArtifactType)
•	text (text, null) — для стихов
•	storage_bucket (text, null)
•	storage_key (text, null)
•	mime_type (text, null)
•	size_bytes (bigint, null)
•	created_at
provider_configs
•	id (uuid, pk)
•	provider_key (text, unique) — yandex_gpt, speechkit, suno, pika, runway, test_text_1
•	kind (enum ProviderKind)
•	is_active (bool)
•	encrypted_api_key (text, null)
•	params_json (jsonb) — model, temperature, endpoint, etc.
•	updated_at
product_configs
•	id (uuid, pk)
•	stage_type (enum StageType, unique)
•	is_enabled (bool)
•	base_price_rub (int)
•	offer_title (text)
•	offer_text (text)
•	upsell_enabled (bool)
•	upsell_conditions_json (jsonb) — правила показа
•	updated_at
pricing_options (для Clip “от 599”)
•	id (uuid, pk)
•	stage_type (enum StageType) — только CLIP
•	label (text) — “HD”, “Short”, “Pro”
•	price_rub (int)
•	provider_params_json (jsonb) — длительность, качество, aspect ratio
•	is_active (bool)
content_policies
•	id (uuid, pk)
•	policy_key (text, unique) — humor_mode, stop_words, poem_rules
•	json_value (jsonb)
•	updated_at
________________________________________
4) Ключевые интерфейсы (точно что нужно реализовать)
4.1. AI провайдеры
# app/infra/ai/base.py
from typing import Protocol

class TextProvider(Protocol):
    provider_key: str
    async def generate_poem(self, prompt: str, params: dict) -> str: ...
4.2. Платежи ЮKassa
# app/infra/payments/yookassa.py
class YooKassaClient:
    async def create_payment(self, amount_rub: int, description: str, metadata: dict, idempotency_key: str) -> dict: ...
    async def parse_webhook(self, request_body: bytes, headers: dict) -> dict: ...
4.3. Хранилище
# app/infra/storage/yandex_object_storage.py
class ObjectStorage:
    async def upload_bytes(self, bucket: str, key: str, data: bytes, mime: str) -> None: ...
    async def signed_url(self, bucket: str, key: str, expires_sec: int) -> str: ...
4.4. Очереди
# app/infra/queue/tasks.py
@celery.task(bind=True, max_retries=2)
def generate_poem_task(self, stage_id: str): ...
________________________________________
5) FSM (точно какие состояния)
# app/bot/fsm/states.py
from aiogram.fsm.state import StatesGroup, State

class PoemFlow(StatesGroup):
    choose_product = State()
    poem_occasion = State()
    poem_recipient = State()
    poem_details = State()
    poem_confirm = State()
    await_payment = State()
    await_generation = State()
    show_result = State()
    upsell_offer = State()
________________________________________
6) Минимальные “use cases” (что писать в application/use_cases)
•	create_order.py
o	создает order + stage(Poem) со статусом awaiting_payment
•	start_payment.py
o	дергает ЮKassa create_payment, сохраняет payment
•	handle_yookassa_webhook.py
o	обновляет payment + stage → paid, ставит enqueue_stage_job
•	enqueue_stage_job.py
o	кладет generate_poem_task(stage_id)
•	deliver_result.py
o	возвращает артефакт/текст по stage
•	get_user_cabinet.py
o	список orders + artifacts
________________________________________
7) Админка (точно какие страницы/роуты)
Страницы
•	/admin/login
•	/admin/dashboard
•	/admin/products (Poem/Voice/Song/Clip + Clip tariffs)
•	/admin/providers (ключи/активность/параметры)
•	/admin/policies (юмор/стоп-слова/правила стиха/ретраи)
•	/admin/orders (таблица)
•	/admin/orders/{order_id} (детали + ручные действия)
•	/webhooks/yookassa (POST)
Ручные действия (POST)
•	/admin/stages/{stage_id}/requeue
•	/admin/stages/{stage_id}/cancel
•	/admin/stages/{stage_id}/mark_failed

