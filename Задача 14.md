Задание для IDE: “Конфигурация LLM” по 4 категориям (StageType) + динамические модели по API-ключу + обновление провайдера/модели во всём проекте
0) Зафиксированные enum’ы (основа архитектуры)

Использовать существующие категории из StageType:

POEM, VOICE, SONG, CLIP 

enums

Использовать ProviderKind как единый справочник провайдеров. Сейчас там есть:

YANDEX_GPT, SPEECHKIT, SUNO, PIKA, DUMMY, GEMINI 

enums

⚠️ Важно: в providers.html уже есть option OPENAI, но его нет в ProviderKind. 

providers


Нужно добавить OPENAI в ProviderKind, чтобы не было рассинхрона UI/бэка.

A) Модель данных: 4 независимых конфигурации (по StageType)
Требование

Хранить конфиг отдельно для каждой категории StageType:

POEM → свой провайдер, свой ключ, своя модель

VOICE → свой провайдер, свой ключ, своя модель

SONG → …

CLIP → …

Реализация (таблица/сущность)

Создать таблицу provider_configs (название любое), 1 строка = 1 StageType:

stage_type (enum/строка) UNIQUE

provider_kind (enum/строка)

api_key_encrypted (строка/байты, шифровать)

model (строка)

models_cache (JSON array строк)

models_cache_updated_at (datetime)

updated_at (datetime)

status (active/invalid/unknown) — опционально, но полезно

Шифрование ключа

Использовать ADMIN_SECRET_KEY (уже есть в settings) как секрет для шифрования/подписи. 

settings

Текущие env-ключи провайдеров в settings.py (YANDEX/SPEECHKIT/SUNO/PIKA/GEMINI) оставить только как fallback на период миграции. 

settings

B) UI: страница /admin/providers → 4 секции
Что сейчас

Одна форма, один провайдер, статический список моделей в JS. 

providers

 

providers

Что нужно

Сделать 4 секции (табы/аккордеон/карточки):

Стих (POEM)

Озвучка (VOICE)

Песня (SONG)

Видео (CLIP)

В каждой секции:

select provider_kind (ограниченный список для этой категории)

input api_key

select model (ОДНО поле модели, без vision_model)

кнопка Сохранить (сохраняет только эту секцию)

Важно

Убрать vision_model из UI (оставить ровно одно поле модели на категорию).

Убрать JS-словарь const models = {...} как источник правды. 

providers


Теперь модели приходят с сервера из models_cache.

C) “Разные провайдеры по категориям” (матрица разрешённых провайдеров)
Требование

Список провайдеров в select должен зависеть от stage_type (4 категории).

Реализация

На бэке завести матрицу, например:

POEM → [YANDEX_GPT, GEMINI, OPENAI]

VOICE → [SPEECHKIT] (+ позже расширите)

SONG → [SUNO]

CLIP → [PIKA]

Основание: ваши текущие доступные ключи в settings. 

settings


И типы категорий — строго из StageType. 

enums

D) Сохранение ключа: сразу подтянуть реальные модели по API-ключу
Требование

После ввода API-ключа и сохранения:

сервер валидирует ключ

сервер запрашивает список доступных моделей по этому ключу

сохраняет список в models_cache

обновляет выпадающий список “Модель” (после редиректа/перезагрузки страницы)

Это должно происходить на сервере, чтобы ключ не светился в браузере.

Поведение выбора модели

Если пользователь выбрал модель, но она не в актуальном списке — показать ошибку и не сохранять (или автозаменить на первую и показать предупреждение — выбрать один вариант и зафиксировать).

Если модель не выбрана — после загрузки моделей выставить первую доступную как дефолт.

E) Ежедневная проверка “новые модели”
Требование

Раз в 24 часа обновлять models_cache для всех записей provider_configs, где есть ключ.

Алгоритм:

если now - models_cache_updated_at >= 24h → дернуть list_models() у провайдера → обновить кэш/дату

если провайдер недоступен/ключ невалиден → статус invalid, кэш не ломать, логировать

F) Глобальная синхронизация: “провайдер/модель должны обновиться во всех файлах”
Основание

stage_type уже используется в заказах как POEM/VOICE/SONG/CLIP. 

order_detail


Именно по stage_type нужно выбирать конфигурацию.

Требование

Создать единый метод:

get_provider_config(stage_type: StageType) -> {provider_kind, api_key, model}

И заменить во всём проекте любые:

прямые обращения к env-ключам settings.*_API_KEY (YANDEX/GEMINI/…) 

settings

захардкоженные provider/model

старую “единую” конфигурацию active_config (сейчас она одна на всё) 

providers

На каждом генераторе/таске:

POEM → cfg(POEM)

VOICE → cfg(VOICE)

SONG → cfg(SONG)

CLIP → cfg(CLIP)

G) Эндпоинты админки (обновить контракт)
Сейчас

Одна форма POST /admin/providers/update без категории. 

providers

Нужно

Сделать сохранение по категории:

POST /admin/providers/update принимает:

stage_type (POEM|VOICE|SONG|CLIP)

provider_kind

api_key

model

Ответ:

редирект обратно на /admin/providers (303 PRG), без JSON-страницы.

H) Acceptance Criteria (готово, когда)

/admin/providers показывает 4 секции: POEM/VOICE/SONG/CLIP (по StageType). 

enums

В каждой секции можно выбрать провайдера (ограниченный список) и ввести ключ + выбрать модель (одно поле модели).

После сохранения ключа список моделей подтягивается реально по API и появляется в select (не из JS-словаря). 

providers

Раз в день список моделей обновляется автоматически.

Если для POEM выбран Gemini + model X, то все места генерации стихов используют именно Gemini + X (без env/hardcode). 

settings

ProviderKind синхронизирован с UI (добавлен OPENAI, т.к. он уже в шаблоне). 

providers

 

enums